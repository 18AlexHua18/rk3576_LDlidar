# 点云输出协议

## 帧格式描述

| 项目名称            | 偏移量 (字节) | 长度 (字节)            | 类型     | 描述                                       |
|-----------------|----------|--------------------|--------|------------------------------------------|
| Pkt_head        | 0        | 4                  | int8   | 55AA5AA5                                 |
| Pkt_cnt         | 4        | 2                  | int16  | 16 位UDP包序号（循环计数）                           |
| Pkt_length      | 6        | 2                  | int16  | 不包括包头和包命令，从 Protocolversion 算起，单位字节      |
| Protocolversion | 8        | 2                  | uint16 | 协议版本号                                    |
| GPS 时间戳         | 10       | 8                  | uint64 | 1970 年起的时间戳（年、月、日、时、分、秒、毫秒、微秒）           |
| TimeSynctype    | 20       | 1                  | uint8  | 0x00：自由计数, 0x02：PTP 授时                   |
| TimeSyncStatus  | 21       | 1                  | uint8  | 0x00：未同步, 0x01：同步丢失, 0x02：已同步, 0x03：同步故障 |
| ProductID       | 22       | 2                  | uint16 | 默认 0x02                                  |
| FrameID         | 24       | 4                  | uint32 | 循环计数，用于表示云图帧                             |
| subFrID         | 28       | 1                  | uint8  | 一个点云图帧中的 0~31 循环计数                       |
| subFrStartColID | 29       | 1                  | uint8  | 起始列号：0, 5, 10, ..., 250, 255             |
| subEndColID     | 30       | 1                  | uint8  | 终止列号：4, 9, 14, ..., 254, 255             |
| Reserved        | 31       | 33                 | -      | 预留字段                                     |
| SubFrDATA       | -        | 128\*52+6\*256\*43 | -      | 128 ：帧头+帧尾，6*256 个通道数据，每个通道数据 43 字节      |
| subFrLoad       | -        | 6\*256\*43         | -      | 6*256 个通道数据，每个通道数据 43 字节                 |

### 每个通道数据（43 字节）

| 字段         | 偏移量 (字节) | 长度 (字节) | 类型     | 描述                         |
|------------|----------|---------|--------|----------------------------|
| X1         | 0        | 2       | int16  | 1 号回波 x 坐标：x1=X1/512（单位：米） |
| X2         | 2        | 2       | int16  | 2 号回波 x 坐标：x2=X2/512（单位：米） |
| X3         | 4        | 2       | int16  | 3 号回波 x 坐标：x3=X3/512（单位：米） |
| Y1         | 6        | 2       | int16  | 1 号回波 y 坐标：y1=Y1/512（单位：米） |
| Y2         | 8        | 2       | int16  | 2 号回波 y 坐标：y2=Y2/512（单位：米） |
| Y3         | 10       | 2       | int16  | 3 号回波 y 坐标：y3=Y3/512（单位：米） |
| Z1         | 12       | 2       | int16  | 1 号回波 z 坐标：z1=Z1/512（单位：米） |
| Z2         | 14       | 2       | int16  | 2 号回波 z 坐标：z2=Z2/512（单位：米） |
| Z3         | 16       | 2       | int16  | 3 号回波 z 坐标：z3=Z3/512（单位：米） |
| D1         | 18       | 2       | uint16 | 1 号回波距离：d1=D1/512（单位：米）    |
| D2         | 20       | 2       | uint16 | 2 号回波距离：d2=D2/512（单位：米）    |
| D3         | 22       | 2       | uint16 | 3 号回波距离：d3=D3/512（单位：米）    |
| Ity1       | 24       | 4       | uint32 | 1 号回波峰值强度                  |
| Ity2       | 28       | 4       | uint32 | 2 号回波峰值强度                  |
| Ity3       | 32       | 4       | uint32 | 3 号回波峰值强度                  |
| Reflexity1 | 36       | 1       | uint8  | 1 号回波反射率                   |
| Reflexity2 | 37       | 1       | uint8  | 2 号回波反射率                   |
| Reflexity3 | 38       | 1       | uint8  | 3 号回波反射率                   |
| Flag1      | 39       | 1       | uint8  | 标识：bit6: echoChooseFlg     |
| Flag2      | 40       | 1       | uint8  | 标识：bit6: echoChooseFlg     |
| Flag3      | 41       | 1       | uint8  | 标识：bit6: echoChooseFlg     |
| Reserved   | 42       | 1       | -      | 预留字段                       |

## 传输格式

### 网口数据传输格式

- 每次子帧数据（6\*256\*43）按如下策略传输（每 5 列加上帧头帧尾）。
- 将子帧数据 Payload (6\*256\*43) 分成 52 包，每一包格式如下：
    - 帧头：0-64 字节
    - Payload：64-1354 字节（1290 字节）
    - 帧尾：1354-1418 字节（64 字节）
    - 每个子帧数据总大小：1418 字节
  
一个点云帧（大帧）分成了32个帧，每个数据帧被封包成52个UDP包

一个点云帧（大帧）有32*52=1664个UDP包

一张云图最大点数192\*256\*3（三个回波均有效）= 147,456


### 带宽需求计算

- 所需传输带宽：92.7 Mb/s
- 计算公式：
```
=((((1418+42)*52)*32)*5*8/1024/1024)
```